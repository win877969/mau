// Fungsi untuk menghasilkan UUID v4 varian 2
function generateUUIDv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0,
            v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Fungsi untuk mengambil parameter dari URL
function getURLParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

async function fetchProxyList() {
    try {
        const response = await fetch('proxy_list.txt');
        if (!response.ok) throw new Error('Failed to load proxy list.');
        const text = await response.text();
        const proxies = text.split('\n').filter(proxy => proxy.trim() !== '');

        const countryParam = getURLParameter('sub'); // Ambil parameter 'sub' dari URL
        const count = getURLParameter('count') || proxies.length; // Ambil jumlah dari URL, default seluruh data
        
        // Filter proxies berdasarkan negara
        const filteredProxies = countryParam ? proxies.filter(proxy => {
            const [ , , country] = proxy.split(',');
            return country.toUpperCase() === countryParam.toUpperCase();
        }) : proxies;

        // Ambil sesuai dengan count
        const proxiesToShow = filteredProxies.slice(0, count);

        const vlessUrls = []; // Untuk menampung semua URL VLESS

        for (const proxy of proxiesToShow) {
            const [ip, port, country, provider] = proxy.split(',');
            const uuid = generateUUIDv4(); // Menghasilkan UUID v4 varian 2

            const vlessUrl = `vless://${uuid}@tp1.bmkg.xyz:443?encryption=none&type=ws&host=tp1.bmkg.xyz&path=%2F${ip}-${port}&security=tls&sni=tp1.bmkg.xyz#${country})+${provider}`;

            vlessUrls.push(vlessUrl); // Tambahkan URL VLESS ke array
        }

        // Tampilkan URL VLESS di console atau lakukan sesuatu dengan vlessUrls
        console.log(vlessUrls.join('\n'));

    } catch (error) {
        console.error('Error:', error);
    }
}

fetchProxyList();
